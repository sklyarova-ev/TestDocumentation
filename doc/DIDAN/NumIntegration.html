<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of NumIntegration</title>
  <meta name="keywords" content="NumIntegration">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">DIDAN</a> &gt; NumIntegration.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for DIDAN&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>NumIntegration
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [tnew,Unew]=NumIntegration(coef,vtau,RHS,t,U,Uss,isolver,Tadd,delta,err,interp1_method,iresult,nfig,iclean,h,v,mark,inc,scheme,varname,logind) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">
 Latest revision 05.11.2019 

 Численное интегрирование модели по времени 

 Внешние процедуры: Matrices, Ploter, Function

 Внутренние процедуры: Step, Res, Jacob

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 ВХОДНЫЕ ПАРАМЕТРЫ:

 coef,vtau - параметры модели

 t - сетка по времени
 U - решение в узлах сетки t
 Uss - стационарное состояние (при нелинейном интегрировании не используется)

 isolver=1 - нелинейное интегрирование: решается задача Коши для исходной 
             системы в интервале времени от t(end) до t(end)+Tadd
             с начальными значениями взятыми из U;

 isolver=2,3 - линейное интегрирование: решается задача Коши для системы, 
               линеаризованной относительно стационарного состояния Uss, 
               в интервале времени от t(end) до t(end)+Tadd с начальными 
               значениями взятыми из  U-Uss, к найденному решению 
               добавляется Uss.

 Tadd -  время интегрирования 
 delta - шаг сетки
 err - точность метода Ньютона (при линейном интегрировании не используется)


 interp1_method - метод интерполяции: 'linear', 'spline', 'pchip'

 iresult=1 - дополнить старое решение новым расчетом,    
         2 - сохранить только новый расчет,       
         3 - сохранить только &quot;хвост&quot; нового расчета, необходимый для 
             продолжения интегрирования, 
         4 - сохранить новый расчет и начальные данные для него.

 nfig - номер фигуры (если nfig&lt;1, то картинка не рисуется).
 iclean=1 - чистить картинку.
 mark - тип линий на графиках
 inc - инкремент выдачи на экран

 scheme - схема интегрирования: 1 - неявный метод Эйлера,
                                2 - BDF2.

 ВЫХОДНЫЕ ПАРАМЕТРЫ:
 tnew - новая сетка по времени
 Unew - решение в узлах новой сетки

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../DIDAN/Functions/Matrices.html" class="code" title="function [L,CM,M]=Matrices(RHS,Uss,coef,delta,vtau,scheme)">Matrices</a>	</li><li><a href="../DIDAN/Functions/Ploter.html" class="code" title="function Ploter(t,U,mark,iclean,h,v,varname,logind)">Ploter</a>	</li><li><a href="../DIDAN/Functions/matlabFunction_new.html" class="code" title="function matlabFunction_new(F,filename,vars)">matlabFunction_new</a>	</li><li><a href="rhsm.html" class="code" title="function F=rhsm(in1,in2,in3,in4,in5,in6,varargin)">rhsm</a>	RHSM%F=RHSM(IN1,IN2,IN3,IN4,IN5,IN6)%ThisfunctionwasgeneratedbytheSymbolicMathToolboxversion8.7.%20-Sep-202123:32:20</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="PeriodicSolutions.html" class="code" title="function [UEXTR,T,Res,ind]=PeriodicSolutions(coef,nss,RHS,AlgPar, vtau,varname, SS_analysisFile,fileToSaveResult)">PeriodicSolutions</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [U,l]=Step(Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,err,scheme)</a></li><li><a href="#_sub2" class="code">function G=Res(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)</a></li><li><a href="#_sub3" class="code">function dGdU=Jacob(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [tnew,Unew]=NumIntegration(coef,vtau,RHS,t,U,Uss,isolver,</a><span class="keyword">...</span>
0002                             Tadd,delta,err,interp1_method,iresult,<span class="keyword">...</span>
0003                                                nfig,iclean,h,v,mark,inc,scheme,varname,logind)
0004 <span class="comment">%</span>
0005 <span class="comment">% Latest revision 05.11.2019</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Численное интегрирование модели по времени</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% Внешние процедуры: Matrices, Ploter, Function</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% Внутренние процедуры: Step, Res, Jacob</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0014 <span class="comment">% ВХОДНЫЕ ПАРАМЕТРЫ:</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% coef,vtau - параметры модели</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% t - сетка по времени</span>
0019 <span class="comment">% U - решение в узлах сетки t</span>
0020 <span class="comment">% Uss - стационарное состояние (при нелинейном интегрировании не используется)</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% isolver=1 - нелинейное интегрирование: решается задача Коши для исходной</span>
0023 <span class="comment">%             системы в интервале времени от t(end) до t(end)+Tadd</span>
0024 <span class="comment">%             с начальными значениями взятыми из U;</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% isolver=2,3 - линейное интегрирование: решается задача Коши для системы,</span>
0027 <span class="comment">%               линеаризованной относительно стационарного состояния Uss,</span>
0028 <span class="comment">%               в интервале времени от t(end) до t(end)+Tadd с начальными</span>
0029 <span class="comment">%               значениями взятыми из  U-Uss, к найденному решению</span>
0030 <span class="comment">%               добавляется Uss.</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% Tadd -  время интегрирования</span>
0033 <span class="comment">% delta - шаг сетки</span>
0034 <span class="comment">% err - точность метода Ньютона (при линейном интегрировании не используется)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% interp1_method - метод интерполяции: 'linear', 'spline', 'pchip'</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% iresult=1 - дополнить старое решение новым расчетом,</span>
0040 <span class="comment">%         2 - сохранить только новый расчет,</span>
0041 <span class="comment">%         3 - сохранить только &quot;хвост&quot; нового расчета, необходимый для</span>
0042 <span class="comment">%             продолжения интегрирования,</span>
0043 <span class="comment">%         4 - сохранить новый расчет и начальные данные для него.</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% nfig - номер фигуры (если nfig&lt;1, то картинка не рисуется).</span>
0046 <span class="comment">% iclean=1 - чистить картинку.</span>
0047 <span class="comment">% mark - тип линий на графиках</span>
0048 <span class="comment">% inc - инкремент выдачи на экран</span>
0049 <span class="comment">%</span>
0050 <span class="comment">% scheme - схема интегрирования: 1 - неявный метод Эйлера,</span>
0051 <span class="comment">%                                2 - BDF2.</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% ВЫХОДНЫЕ ПАРАМЕТРЫ:</span>
0054 <span class="comment">% tnew - новая сетка по времени</span>
0055 <span class="comment">% Unew - решение в узлах новой сетки</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0058 <span class="comment">%</span>
0059 [filepath,~,~] = fileparts(mfilename(<span class="string">'fullpath'</span>));
0060 addpath(genpath(filepath));
0061 
0062 <span class="comment">% Формирование функции matlab, вычисляющей правую часть системы</span>
0063 [Var,F]=RHS(coef);
0064 <a href="../DIDAN/Functions/matlabFunction_new.html" class="code" title="function matlabFunction_new(F,filename,vars)">matlabFunction_new</a>(F,<span class="string">'rhsm.m'</span>,Var);
0065 <span class="comment">%</span>
0066 <span class="comment">% Формирование функции matlab, вычисляющей матрицу Якоби</span>
0067 dGdU=jacobian(F,Var{1,1});
0068 <a href="../DIDAN/Functions/matlabFunction_new.html" class="code" title="function matlabFunction_new(F,filename,vars)">matlabFunction_new</a>(dGdU,<span class="string">'jac.m'</span>,Var);
0069 
0070 <span class="comment">%</span>
0071 <span class="comment">% Сетка по времени для новых расчетов:</span>
0072 vtau = sort(vtau); 
0073 vm=ceil(vtau/delta);
0074 vm1=zeros(10,1); <span class="comment">%%%%TODO:WHY 10?</span>
0075 vm1(1:size(vm,1))=vm;
0076 mp=vm(end);
0077 K=ceil(Tadd/delta);
0078 
0079 <span class="keyword">if</span>(K==0)
0080    disp(<span class="string">'Время интегрирования меньше одного шага'</span>)
0081    STOP
0082 <span class="keyword">end</span>    
0083 tadd=t(end)+((1-mp):1:K)*delta; 
0084 <span class="comment">% tadd(1)=t(end)-tau_A+delta=t(end)-(mp-1)*delta</span>
0085 <span class="comment">% tadd(1+mp-m)=t(end)-tau+delta=t(end)-(m-1)*delta</span>
0086 <span class="comment">% tadd(mp)=t(end)</span>
0087 <span class="comment">% tadd(mp+K)=t(end)+T=t(end)+K*delta</span>
0088 <span class="comment">%</span>
0089 <span class="comment">% Формирование матрицы начальных значений:</span>
0090 Uadd=zeros(size(Var{1,1},1),mp+K);
0091 k=sum(t-t(end)&lt;=-vtau(end));
0092 <span class="keyword">if</span>(k&lt;1)
0093    disp(<span class="string">'t(1)&gt;t(end)-tau_A'</span>)
0094    STOP
0095 <span class="keyword">end</span>
0096 <span class="comment">%Встроенная функция для интерполирования</span>
0097 Uadd(:,1:mp)=interp1(t(k:end),U(:,k:end)',tadd(1:mp),interp1_method)';
0098 
0099 <span class="comment">%</span>
0100 <span class="keyword">if</span>(isolver==1)
0101 <span class="comment">% Нелинейное интегрирование по времени:</span>
0102    nns=0; 
0103    <span class="keyword">for</span> k=mp+1:mp+K
0104       [Uadd(:,k),nnsk]=<a href="#_sub1" class="code" title="subfunction [U,l]=Step(Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,err,scheme)">Step</a>(Uadd(:,k-1),Uadd(:,k-2),Uadd(:,k-vm1(1)),<span class="keyword">...</span>
0105                                     Uadd(:,k-vm1(2)),Uadd(:,k-vm1(3)),<span class="keyword">...</span>
0106                                     Uadd(:,k-vm1(4)),Uadd(:,k-vm1(5)),<span class="keyword">...</span>
0107                                     Uadd(:,k-vm1(6)),Uadd(:,k-vm1(7)),<span class="keyword">...</span>
0108                                     Uadd(:,k-vm1(8)),Uadd(:,k-vm1(9)),<span class="keyword">...</span>
0109                                     Uadd(:,k-vm1(10)),delta,err,scheme);
0110       nns=nns+nnsk;
0111       <span class="comment">%nnsk-кол-во итераций метода Ньютона за один шаг по сетке времени</span>
0112       <span class="keyword">if</span> (mod(k-mp,inc)==0) <span class="comment">% информация о работе метода</span>
0113          fprintf(1,<span class="string">'t=%g, nns=%g\n'</span>,t(end)+(k-mp)*delta,nns);
0114          nns=0;
0115       <span class="keyword">end</span>
0116       <span class="comment">%if (nnsk==10)</span>
0117        <span class="comment">%   fprintf('t=%g\n',t(end)+(k-mp)*delta);</span>
0118         <span class="comment">%  pause</span>
0119           <span class="comment">%fprintf(Norm);</span>
0120           <span class="comment">%fprintf('t=%g, iter=%g, n_be=%g, n_af=%g ratio=%g\n',t(end)+(k-mp)*delta,nnsk,k1,k2,k1/k2);</span>
0121           <span class="comment">%pause</span>
0122       <span class="comment">%end</span>
0123    <span class="keyword">end</span>    
0124   
0125 <span class="keyword">elseif</span>(isolver==2)
0126 <span class="comment">% Линейное интегрирование по времени:</span>
0127    [~,CM]=<a href="../DIDAN/Functions/Matrices.html" class="code" title="function [L,CM,M]=Matrices(RHS,Uss,coef,delta,vtau,scheme)">Matrices</a>(Uss,coef,delta,vtau,scheme);
0128    Uadd(:,1:mp)=Uadd(:,1:mp)-Uss*ones(1,mp);
0129    <span class="keyword">for</span> k=mp+1:mp+K
0130        Uadd(:,k)=CM{1,1}*Uadd(:,k-1)+CM{1,2}*Uadd(:,k-2);
0131        <span class="keyword">for</span> j=3:size(CM,2)
0132            Uadd(:,k)=Uadd(:,k)+CM{1,j}*Uadd(:,k-vm(j-2));
0133        <span class="keyword">end</span>
0134       <span class="keyword">if</span> (mod(k-mp,inc)==0) 
0135          fprintf(1,<span class="string">'t=%g\n'</span>,(k-mp)*delta);
0136       <span class="keyword">end</span>    
0137    <span class="keyword">end</span> 
0138    Uadd=Uadd+Uss*ones(1,size(Uadd,2));
0139 <span class="keyword">elseif</span>(isolver==3)
0140 <span class="comment">% Линейное интегрирование по времени:</span>
0141    [~,~,M]=<a href="../DIDAN/Functions/Matrices.html" class="code" title="function [L,CM,M]=Matrices(RHS,Uss,coef,delta,vtau,scheme)">Matrices</a>(Uss,coef,delta,m,mp,scheme);
0142    Uadd(:,1:mp)=Uadd(:,1:mp)-Uss*ones(1,mp);
0143    X=Uadd(:,mp:-1:1);
0144    X=sparse(X(:));
0145    <span class="keyword">for</span> k=mp+1:mp+K
0146       X=M*X;
0147       Uadd(:,k)=full(X(1:size(Uss,1)));
0148       <span class="keyword">if</span> (mod(k-mp,inc)==0) 
0149          fprintf(1,<span class="string">'t=%g\n'</span>,(k-mp)*delta);
0150       <span class="keyword">end</span>    
0151    <span class="keyword">end</span> 
0152    Uadd=Uadd+Uss*ones(1,size(Uadd,2));   
0153 <span class="keyword">end</span>
0154 <span class="comment">% Отрисовка нового расчета и его начальных данных:</span>
0155 <span class="keyword">if</span> (nfig&gt;0)
0156    figure(nfig)
0157  <a href="../DIDAN/Functions/Ploter.html" class="code" title="function Ploter(t,U,mark,iclean,h,v,varname,logind)">Ploter</a>(tadd,Uadd,mark,iclean,h,v,varname,logind) 
0158 <span class="keyword">end</span>
0159 <span class="comment">%</span>
0160 <span class="keyword">if</span>(iresult==1)
0161 <span class="comment">% дополнить старое решение новыми расчетами:</span>
0162    tnew=[t,tadd(mp+1:mp+K)];
0163    Unew=[U,Uadd(:,mp+1:mp+K)]; 
0164 <span class="keyword">elseif</span>(iresult==2)
0165 <span class="comment">% сохранить только новый расчет:</span>
0166    tnew=tadd(mp+1:mp+K); 
0167    Unew=Uadd(:,mp+1:mp+K);
0168 <span class="keyword">elseif</span>(iresult==3) 
0169 <span class="comment">% сохранить только &quot;хвост&quot; нового расчета, необходимый для продолжения интегрирования:</span>
0170    tnew=tadd(K:mp+K);
0171    Unew=Uadd(:,K:mp+K);
0172 <span class="keyword">elseif</span>(iresult==4)
0173 <span class="comment">% сохранить новый расчет и начальные данные для него:</span>
0174    tnew=tadd; 
0175    Unew=Uadd;   
0176 <span class="keyword">end</span> 
0177 clear t U tadd Uadd
0178 delete jac.m
0179 delete rhsm.m
0180 
0181 <a name="_sub1" href="#_subfunctions" class="code">function [U,l]=Step(Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,err,scheme)</a>
0182 <span class="comment">%</span>
0183 <span class="comment">% Latest revision 03.01.2017</span>
0184 <span class="comment">%</span>
0185 <span class="comment">% Шаг решения задачи Коши.</span>
0186 <span class="comment">%</span>
0187 <span class="comment">% Udelta,Udelta2,Vtau,Eptau,Vtaua - заданные  значения</span>
0188 <span class="comment">% U - значение в следующем узле сетки</span>
0189 <span class="comment">% coef - коэффициенты модели</span>
0190 <span class="comment">% delta - шаг сетки</span>
0191 <span class="comment">% err - точность решения нелинейного уравнения, к которому сводиться</span>
0192 <span class="comment">%       реализация шага метода</span>
0193 <span class="comment">% scheme=1 - неявный метод Эйлера</span>
0194 <span class="comment">%        2 - BDF2</span>
0195 <span class="comment">%</span>
0196 U=Udelta;
0197 G=<a href="#_sub2" class="code" title="subfunction G=Res(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)">Res</a>(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme);
0198 normG=norm(G,2);
0199 err=err*norm(U,2);
0200 l=0;
0201 <span class="keyword">while</span>(normG&gt;err &amp;&amp; l&lt;15)<span class="comment">%ограничить число шагов</span>
0202    U=U-<a href="#_sub3" class="code" title="subfunction dGdU=Jacob(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)">Jacob</a>(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)\G;
0203    U(U&lt;0)=0;
0204    G=<a href="#_sub2" class="code" title="subfunction G=Res(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)">Res</a>(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme);
0205    normG=norm(G,2);
0206    l=l+1;
0207    
0208    <span class="comment">%if l&gt;1000</span>
0209    <span class="comment">%    disp(norm(G,2));</span>
0210     <span class="comment">%   if l==1120</span>
0211     <span class="comment">%       stop</span>
0212     <span class="comment">%   end</span>
0213    <span class="comment">%end</span>
0214 <span class="keyword">end</span>
0215 
0216     
0217 
0218 <a name="_sub2" href="#_subfunctions" class="code">function G=Res(U,Udelta,Udelta2,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)</a>
0219 <span class="comment">%</span>
0220 <span class="comment">% Latest revision 03.01.2017</span>
0221 <span class="comment">%</span>
0222 <span class="keyword">if</span>(scheme==1)
0223    G=(U-Udelta)/delta; 
0224 <span class="keyword">elseif</span>(scheme==2)    
0225    G=(1.5*(U-Udelta)+0.5*(Udelta2-Udelta))/delta;
0226 <span class="keyword">end</span>
0227 g=<a href="rhsm.html" class="code" title="function F=rhsm(in1,in2,in3,in4,in5,in6,varargin)">rhsm</a>(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10);
0228 G=G-g';
0229   
0230 <a name="_sub3" href="#_subfunctions" class="code">function dGdU=Jacob(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10,delta,scheme)</a>
0231 <span class="comment">%</span>
0232 <span class="comment">% Latest revision 12.10.2019</span>
0233 <span class="comment">%</span>
0234 <span class="comment">%</span>
0235 <span class="keyword">if</span>(scheme==1)
0236    dGdU=(1.0/delta)*eye(size(U,1)); 
0237 <span class="keyword">elseif</span>(scheme==2)
0238    dGdU=(1.5/delta)*eye(size(U,1));
0239 <span class="keyword">end</span>    
0240 dGdU=dGdU-jac(U,U1,U2,U3,U4,U5,U6,U7,U8,U9,U10);
0241 
0242 
0243     
0244     
0245  
0246 
0247</pre></div>
<hr><address>Generated on Tue 21-Sep-2021 01:27:30 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>